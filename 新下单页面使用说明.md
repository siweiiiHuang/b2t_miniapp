# 新下单页面功能说明

## 已完成的功能

### 1. 修复了加入购物车功能
- **问题**: 首页商品的"加入购物车"按钮只显示成功提示，但没有实际调用API
- **解决**: 修改了 `pages/index/index/index.js` 中的 `addCart` 函数，现在会：
  - 检查用户登录状态
  - 调用 `/api/cart/add` 接口添加商品到购物车
  - 显示真实的成功/失败提示
  - 更新购物车数量

### 2. 创建了新的下单确认页面
- **页面路径**: `pages/cart/order_confirm/order_confirm`
- **功能特点**:
  - 现代化的UI设计，参考了HTML5版本的样式
  - 支持收货地址选择和编辑
  - 支持快递方式选择（目前只有顺丰，京东已屏蔽）
  - 集成顺丰物流费计算API (`/api/ShunfengLogistics/calcFeeV2`)
  - 支持优惠券选择
  - 支持发票信息设置
  - 支持买家留言（50字限制）
  - 实时计算订单金额
  - 完整的表单验证

### 3. 更新了页面跳转逻辑
- **购物车结算**: `pages/cart/cart/cart.js` 现在跳转到新的下单确认页面
- **立即购买**: `pages/goods/goodsInfo/goodsInfo.js` 现在跳转到新的下单确认页面
- **地址选择**: `pages/user/address_list/address_list.js` 支持新页面的地址回传

## 技术实现细节

### 物流费计算逻辑
物流费会在以下情况自动重新计算：
1. **页面加载时** - 获取到默认地址后立即计算
2. **选择地址后** - 从地址列表返回时重新计算
3. **商品数量变化时** - boxCount参数变化时重新计算

计算流程：
```javascript
1. 检查必要参数（user_id, address_id, boxCount）
2. 显示"计算中..."状态
3. 调用 POST /api/ShunfengLogistics/calcFeeV2
4. 成功后更新物流费显示
5. 自动重新计算订单总价
```

### API调用
1. **顺丰物流费计算**:
   ```javascript
   POST /api/ShunfengLogistics/calcFeeV2
   参数: {
     user_id: 用户ID,
     address_id: 地址ID,
     boxCount: 商品数量
   }
   ```

2. **订单数据获取**: 复用现有的 `/api/cart/cart2` 接口
3. **价格计算**: 复用现有的 `/api/cart/cart3` 接口
4. **订单提交**: 复用现有的订单提交流程

### 数据流程
1. 用户选择商品 → 加入购物车/立即购买
2. 跳转到新下单确认页面
3. 自动获取用户默认地址和商品信息
4. 调用顺丰API计算物流费
5. 用户选择快递方式、优惠券等
6. 实时计算总价
7. 提交订单 → 跳转支付页面

### 样式特点
- 采用温暖的米色背景 (#f9f6f0)
- 棕色主题色 (#8B4513) 符合"酥仙记"品牌调性
- 现代化的卡片式布局
- 清晰的信息层级
- 友好的交互反馈
- **使用原生导航栏** - 更简洁，无需自定义顶部导航

## 使用方法

1. **从首页加入购物车**:
   - 点击商品的"加入购物车"按钮
   - 系统会自动调用API添加到购物车
   - 显示成功提示

2. **从购物车结算**:
   - 在购物车页面选择商品
   - 点击"结算"按钮
   - 跳转到新的下单确认页面

3. **立即购买**:
   - 在商品详情页选择规格
   - 点击"立即购买"
   - 跳转到新的下单确认页面

4. **在下单确认页面**:
   - 选择或添加收货地址
   - 选择快递方式（目前只有顺丰）
   - 可选择优惠券和发票
   - 填写买家留言
   - 确认金额后提交订单

## 注意事项

1. **快递选择**: 目前只开放顺丰快递，京东快递已按要求屏蔽
2. **物流费计算**: 
   - 依赖后端的顺丰API (`/api/ShunfengLogistics/calcFeeV2`)
   - 需要用户ID、地址ID、商品数量三个参数
   - 会在地址选择后和商品数量变化时自动重新计算
   - 如果API返回失败会显示"计算失败"
3. **地址管理**: 复用现有的地址管理系统
4. **支付流程**: 提交订单后会跳转到现有的支付页面 (`cart4`)
5. **导航栏**: 使用微信原生导航栏，标题为"填写订单"

## 后续可扩展功能

1. 添加更多快递公司支持
2. 支持自提门店选择
3. 支持预约配送时间
4. 添加商品规格修改功能
5. 支持批量优惠券选择