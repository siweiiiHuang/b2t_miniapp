# 后端获取微信小程序手机号实现说明

## 一、前端传递的参数

前端在调用 `/api/user/thirdLogin` 接口时，如果用户授权了手机号，会在请求参数中传递 `phoneCode` 字段：

```json
{
  "code": "微信登录code",
  "phoneCode": "手机号授权code（如果用户授权了手机号）",
  "nickname": "用户昵称",
  "head_pic": "头像",
  // ... 其他参数
}
```

## 二、后端实现步骤

### 步骤1：获取 access_token

首先需要使用小程序的 `appid` 和 `appsecret` 获取接口调用凭证 `access_token`：

**接口地址：**
```
GET https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=APPID&secret=APPSECRET
```

**返回示例：**
```json
{
  "access_token": "ACCESS_TOKEN",
  "expires_in": 7200
}
```

**注意事项：**
- `access_token` 有效期为 7200 秒（2小时）
- 建议后端缓存 `access_token`，避免频繁请求
- 如果 `access_token` 过期，需要重新获取

### 步骤2：通过 phoneCode 获取手机号

使用获取到的 `access_token` 和前端传递的 `phoneCode` 调用微信接口获取手机号：

**接口地址：**
```
POST https://api.weixin.qq.com/wxa/business/getuserphonenumber?access_token=ACCESS_TOKEN
```

**请求参数：**
```json
{
  "code": "前端传递的phoneCode"
}
```

**返回示例：**
```json
{
  "errcode": 0,
  "errmsg": "ok",
  "phone_info": {
    "phoneNumber": "用户手机号",
    "purePhoneNumber": "不带区号的手机号",
    "countryCode": "86",
    "watermark": {
      "timestamp": 1637743194,
      "appid": "小程序appid"
    }
  }
}
```

**错误码说明：**
- `0`: 成功
- `40013`: 无效的 access_token
- `40029`: code 无效或已过期（phoneCode 有效期5分钟）
- `45011`: 频率限制，每个用户每分钟最多调用5次

## 三、后端代码示例

### PHP 示例

```php
<?php
/**
 * 通过 phoneCode 获取用户手机号
 * @param string $phoneCode 前端传递的手机号授权code
 * @param string $appid 小程序appid
 * @param string $appsecret 小程序appsecret
 * @return array|false 成功返回手机号信息，失败返回false
 */
function getPhoneNumberByCode($phoneCode, $appid, $appsecret) {
    // 1. 获取 access_token（建议缓存，避免频繁请求）
    $accessToken = getAccessToken($appid, $appsecret);
    if (!$accessToken) {
        return false;
    }
    
    // 2. 调用微信接口获取手机号
    $url = "https://api.weixin.qq.com/wxa/business/getuserphonenumber?access_token=" . $accessToken;
    $data = json_encode(['code' => $phoneCode]);
    
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
    
    $response = curl_exec($ch);
    curl_close($ch);
    
    $result = json_decode($response, true);
    
    if (isset($result['errcode']) && $result['errcode'] == 0) {
        return $result['phone_info'];
    }
    
    return false;
}

/**
 * 获取 access_token（建议缓存）
 */
function getAccessToken($appid, $appsecret) {
    // 先尝试从缓存获取
    $cacheKey = 'wechat_access_token_' . $appid;
    $accessToken = getCache($cacheKey);
    if ($accessToken) {
        return $accessToken;
    }
    
    // 缓存不存在或过期，重新获取
    $url = "https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid={$appid}&secret={$appsecret}";
    $response = file_get_contents($url);
    $result = json_decode($response, true);
    
    if (isset($result['access_token'])) {
        // 缓存 access_token，有效期设置为 7000 秒（比实际有效期少200秒，避免边界问题）
        setCache($cacheKey, $result['access_token'], 7000);
        return $result['access_token'];
    }
    
    return false;
}

/**
 * 在 thirdLogin 接口中使用
 */
public function thirdLogin() {
    $phoneCode = $_POST['phoneCode'] ?? '';
    $phoneNumber = '';
    
    // 如果传递了 phoneCode，则获取手机号
    if (!empty($phoneCode)) {
        $phoneInfo = getPhoneNumberByCode($phoneCode, $this->appid, $this->appsecret);
        if ($phoneInfo) {
            $phoneNumber = $phoneInfo['phoneNumber'];
        }
    }
    
    // 继续处理登录逻辑，$phoneNumber 即为用户手机号
    // ...
}
```

### Node.js 示例

```javascript
const axios = require('axios');

/**
 * 获取 access_token（建议使用缓存）
 */
async function getAccessToken(appid, appsecret) {
    // 先尝试从缓存获取
    const cacheKey = `wechat_access_token_${appid}`;
    const cachedToken = await getCache(cacheKey);
    if (cachedToken) {
        return cachedToken;
    }
    
    // 缓存不存在，重新获取
    const url = `https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=${appid}&secret=${appsecret}`;
    const response = await axios.get(url);
    
    if (response.data.access_token) {
        // 缓存 access_token，有效期 7000 秒
        await setCache(cacheKey, response.data.access_token, 7000);
        return response.data.access_token;
    }
    
    return null;
}

/**
 * 通过 phoneCode 获取用户手机号
 */
async function getPhoneNumberByCode(phoneCode, appid, appsecret) {
    try {
        // 1. 获取 access_token
        const accessToken = await getAccessToken(appid, appsecret);
        if (!accessToken) {
            throw new Error('获取 access_token 失败');
        }
        
        // 2. 调用微信接口获取手机号
        const url = `https://api.weixin.qq.com/wxa/business/getuserphonenumber?access_token=${accessToken}`;
        const response = await axios.post(url, {
            code: phoneCode
        });
        
        if (response.data.errcode === 0) {
            return response.data.phone_info;
        }
        
        throw new Error(`获取手机号失败: ${response.data.errmsg}`);
    } catch (error) {
        console.error('获取手机号错误:', error);
        return null;
    }
}

/**
 * 在 thirdLogin 接口中使用
 */
async function thirdLogin(req, res) {
    const { phoneCode, code, nickname, head_pic, ...otherParams } = req.body;
    let phoneNumber = '';
    
    // 如果传递了 phoneCode，则获取手机号
    if (phoneCode) {
        const phoneInfo = await getPhoneNumberByCode(phoneCode, APPID, APPSECRET);
        if (phoneInfo) {
            phoneNumber = phoneInfo.phoneNumber;
        }
    }
    
    // 继续处理登录逻辑，phoneNumber 即为用户手机号
    // ...
}
```

### Python 示例

```python
import requests
import json
import time

class WeChatPhoneNumber:
    def __init__(self, appid, appsecret):
        self.appid = appid
        self.appsecret = appsecret
        self.access_token_cache = {}
    
    def get_access_token(self):
        """获取 access_token（带缓存）"""
        cache_key = f'wechat_access_token_{self.appid}'
        
        # 检查缓存
        if cache_key in self.access_token_cache:
            token_data = self.access_token_cache[cache_key]
            # 检查是否过期（提前200秒刷新）
            if time.time() < token_data['expires_at']:
                return token_data['token']
        
        # 重新获取
        url = f'https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid={self.appid}&secret={self.appsecret}'
        response = requests.get(url)
        result = response.json()
        
        if 'access_token' in result:
            # 缓存 token
            self.access_token_cache[cache_key] = {
                'token': result['access_token'],
                'expires_at': time.time() + 7000  # 提前200秒过期
            }
            return result['access_token']
        
        return None
    
    def get_phone_number(self, phone_code):
        """通过 phoneCode 获取手机号"""
        access_token = self.get_access_token()
        if not access_token:
            return None
        
        url = f'https://api.weixin.qq.com/wxa/business/getuserphonenumber?access_token={access_token}'
        data = {'code': phone_code}
        
        response = requests.post(url, json=data)
        result = response.json()
        
        if result.get('errcode') == 0:
            return result.get('phone_info')
        
        return None

# 使用示例
def third_login(request):
    phone_code = request.POST.get('phoneCode', '')
    phone_number = ''
    
    if phone_code:
        wechat = WeChatPhoneNumber(APPID, APPSECRET)
        phone_info = wechat.get_phone_number(phone_code)
        if phone_info:
            phone_number = phone_info.get('phoneNumber', '')
    
    # 继续处理登录逻辑
    # ...
```

## 四、注意事项

1. **access_token 缓存**：`access_token` 有效期为 2 小时，建议后端缓存，避免频繁请求
2. **phoneCode 有效期**：`phoneCode` 有效期为 5 分钟，需要在有效期内使用
3. **频率限制**：每个用户每分钟最多调用 5 次获取手机号接口
4. **错误处理**：需要妥善处理各种错误情况（access_token 过期、phoneCode 无效等）
5. **安全性**：`appsecret` 必须保密，不能暴露在前端代码中

## 五、接口调用流程

```
前端授权手机号
    ↓
获取 phoneCode
    ↓
调用 /api/user/thirdLogin，传递 phoneCode
    ↓
后端接收 phoneCode
    ↓
获取 access_token（从缓存或微信接口）
    ↓
调用微信接口获取手机号
    ↓
返回手机号信息
    ↓
后端处理登录逻辑，保存手机号
```

## 六、参考文档

- 微信官方文档：https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/phonenumber/phonenumber.getPhoneNumber.html




